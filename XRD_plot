import pandas as pd
import matplotlib.pyplot as plt
from scipy.signal import find_peaks
from tkinter import Tk
from tkinter.filedialog import askopenfilename


def selecionar_arquivo():
    """Abre uma janela para selecionar o arquivo .xy"""
    Tk().withdraw()
    caminho = askopenfilename(
        title="Selecione o arquivo de DRX",
        filetypes=[("Arquivos XY", "*.xy"), ("Todos os arquivos", "*.*")]
    )
    return caminho


def ler_arquivo_drx_xy(caminho_arquivo):
    """Lê o arquivo de DRX no formato .xy, ignorando metadados"""
    dados = pd.read_csv(caminho_arquivo, skiprows=1, sep="\s+", header=None, usecols=[0, 1])
    dados.columns = ["2theta", "intensidade"]
    return dados


def plotar_drx(dados, picos=None):
    """Plota o padrão de DRX, destacando os picos se fornecidos"""
    plt.figure(figsize=(10, 6))
    plt.plot(dados["2theta"], dados["intensidade"], label="COP008", color="black")

    if picos is not None:
        plt.plot(dados["2theta"][picos], dados["intensidade"][picos], "ro", label="Picos")

    plt.xlabel("2θ (Degrees)")
    plt.ylabel("Intensity")
    plt.title("XRD pattern from COP008")
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()


def detectar_picos(dados, altura_minima=100):
    """Detecta picos com base na intensidade mínima"""
    intensidades = dados["intensidade"].values
    picos, _ = find_peaks(intensidades, height=altura_minima)
    return picos


# PROGRAMA PRINCIPAL
if __name__ == "__main__":
    caminho = selecionar_arquivo()

    if caminho:
        dados = ler_arquivo_drx_xy(caminho)

        print("\nArquivo carregado com sucesso!")
        print(dados.head())

        # Detectar picos
        picos = detectar_picos(dados, altura_minima=100)
        print(f"\nNúmero de picos detectados: {len(picos)}")
        print(dados)

        # Plotar gráfico com os picos destacados
        plotar_drx(dados)

    else:
        print("Nenhum arquivo foi selecionado.")
